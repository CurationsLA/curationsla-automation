name: CurationsLA Daily Content Generation
# Runs Monday-Friday at 6:00 AM Pacific Time

on:
  schedule:
    # 6:00 AM PST / 7:00 AM PDT (14:00 UTC / 13:00 UTC)
    - cron: '0 14 * * 1-5'  # Adjust for DST as needed
  workflow_dispatch:  # Allow manual trigger
    inputs:
      day_override:
        description: 'Day to generate (monday, tuesday, wednesday, thursday, friday)'
        required: false
        default: 'auto'

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Deploy specialized agents
      env:
        PYTHONPATH: scripts:$PYTHONPATH
      run: |
        python scripts/deploy_specialized_agents.py || {
          echo "âš ï¸ Agent deployment had issues, continuing with default configuration"
          exit 0
        }
    
    - name: Set timezone to LA
      run: |
        sudo timedatectl set-timezone America/Los_Angeles
        echo "Current LA time: $(date)"
    
    - name: Determine day of week
      id: get-day
      run: |
        if [ "${{ github.event.inputs.day_override }}" != "auto" ] && [ -n "${{ github.event.inputs.day_override }}" ]; then
          DAY="${{ github.event.inputs.day_override }}"
        else
          DAY=$(date +%A | tr '[:upper:]' '[:lower:]')
        fi
        echo "day=$DAY" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "ğŸ“… Generating content for: $DAY"
    
    - name: Run content aggregation
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PYTHONPATH: scripts:$PYTHONPATH
      run: |
        echo "ğŸŒ´ Starting CurationsLA content generation..."
        timeout 300 python scripts/content_generator.py || {
          echo "âŒ Content generation failed or timed out, but continuing with available content"
          # Create minimal content if generation failed completely
          if [ ! -d "output/$(date +%Y-%m-%d)" ]; then
            mkdir -p "output/$(date +%Y-%m-%d)"
            echo "# CurationsLA Newsletter - $(date +%A, %B %d, %Y)" > "output/$(date +%Y-%m-%d)/newsletter-web.md"
            echo "Content generation encountered issues - please check logs" >> "output/$(date +%Y-%m-%d)/newsletter-web.md"
          fi
          exit 0
        }
    
    - name: Generate Schema markup
      env:
        PYTHONPATH: scripts:$PYTHONPATH
      run: |
        python scripts/schema_builder.py --day ${{ steps.get-day.outputs.day }} || {
          echo "âš ï¸ Schema generation skipped due to error"
          exit 0
        }
    
    - name: Create AI discovery files
      env:
        PYTHONPATH: scripts:$PYTHONPATH
      run: |
        python scripts/ai_discovery.py || {
          echo "âš ï¸ AI discovery file generation skipped due to error"
          exit 0
        }
    
    - name: Archive content
      run: |
        # Create archive structure
        YEAR=$(date +%Y)
        MONTH=$(date +%m-%B | tr '[:upper:]' '[:lower:]')
        WEEK=$(date +%U)
        DAY=${{ steps.get-day.outputs.day }}
        DATE=${{ steps.get-day.outputs.date }}
        
        ARCHIVE_PATH="content/$YEAR/$MONTH/week-$WEEK/$DAY"
        mkdir -p $ARCHIVE_PATH
        
        # Copy generated content to archive if it exists
        if [ -d "output/$DATE" ]; then
          cp -r output/$DATE/* $ARCHIVE_PATH/ 2>/dev/null || {
            echo "âš ï¸ Some output files could not be copied"
          }
          echo "ğŸ“ Content archived to: $ARCHIVE_PATH"
        else
          echo "âš ï¸ No output directory found for $DATE"
          # Create basic content structure
          echo "# CurationsLA Newsletter - $DAY $DATE" > $ARCHIVE_PATH/README.md
          echo "Content generation incomplete for this date" >> $ARCHIVE_PATH/README.md
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Only commit and push if there are changes
        if ! git diff --quiet || ! git diff --cached --quiet; then
          git add .
          git commit -m "ğŸŒ´ CurationsLA: ${{ steps.get-day.outputs.day }} content - ${{ steps.get-day.outputs.date }}"
          git push origin ${{ github.ref_name }}
        else
          echo "No changes to commit"
        fi
    
    - name: Generate preview links
      id: preview
      run: |
        DAY=${{ steps.get-day.outputs.day }}
        DATE=${{ steps.get-day.outputs.date }}
        
        echo "## ğŸ“§ Newsletter Preview Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Email Version (Anti-Clipping)" >> $GITHUB_STEP_SUMMARY
        echo "[View Email Version](https://github.com/${{ github.repository }}/blob/main/output/$DATE/newsletter-email.md)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Web Version (Full Content)" >> $GITHUB_STEP_SUMMARY
        echo "[View Web Version](https://github.com/${{ github.repository }}/blob/main/output/$DATE/newsletter-web.md)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Schema Markup" >> $GITHUB_STEP_SUMMARY
        echo "[View Schema JSON](https://github.com/${{ github.repository }}/blob/main/output/$DATE/schema.json)" >> $GITHUB_STEP_SUMMARY
    
    - name: Content generation complete
      run: |
        echo "âœ… CurationsLA Newsletter content generated successfully!"
        echo "ğŸ“„ Text content is ready for copy-paste use"
        echo "ğŸ“ Generated files location: output/${{ steps.get-day.outputs.date }}/"
    
    - name: Update status badge
      if: always()
      run: |
        # Update README with latest generation status
        STATUS="![Newsletter Status](https://img.shields.io/badge/Newsletter-${{ steps.get-day.outputs.day }}_Generated-success)"
        echo "$STATUS" > status.md
        
  cleanup-old-content:
    runs-on: ubuntu-latest
    needs: generate-newsletter
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Clean up old outputs
      run: |
        # Keep only last 30 days of output
        find output -type d -mtime +30 -exec rm -rf {} + 2>/dev/null || true
        echo "â™»ï¸ Cleaned up outputs older than 30 days"